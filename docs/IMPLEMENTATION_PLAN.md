# SimpleLIMS-Offline 实施计划

## 项目概述

**定位**：面向发展中国家小型临床实验室的离线优先桌面端管理系统 (LIMS)

**核心价值**：
- 离线优先 (Offline First) - 完全本地化运行
- 即插即用 (Plug & Play) - 内置仪器驱动库
- 仪器自动化 (Automation) - 自动采集检验结果，消除手工录入错误

**技术栈**：
- Runtime: Electron
- Frontend: React + TypeScript + Tailwind CSS + Vite
- Database: SQLite (Better-SQLite3 + WAL 模式)
- 通讯: serialport (RS232), net (TCP/IP), chokidar (文件监听)

---

## 实施阶段

### Phase 1: 基础架构搭建 (2 周)

**目标**：建立 Electron + React + SQLite 开发环境

| 任务 | 优先级 | 预估时间 |
|------|--------|----------|
| 配置 Electron + Vite + React 开发环境 | P0 | 2天 |
| 从 SimpleLabOS 迁移 UI 组件库 | P0 | 2天 |
| 搭建 SQLite 本地数据库 (WAL 模式) | P0 | 2天 |
| 设计核心数据模型 (Patient/Sample/Test/Result) | P0 | 2天 |
| 实现 Electron 主进程/渲染进程架构 | P0 | 2天 |

**交付物**：
- 可运行的 Electron 应用框架
- 基础 UI 组件库
- 数据库连接与 ORM 配置

---

### Phase 2: 核心业务流程 MVP (3 周)

**目标**：实现最小可用的检验流程闭环

| 任务 | 优先级 | 预估时间 |
|------|--------|----------|
| 患者登记 (Patient Registration) | P0 | 2天 |
| 检验项目目录 (Test Catalog) | P0 | 2天 |
| 样本开单 (Order Entry) | P0 | 3天 |
| 结果录入 (手动模式) | P0 | 2天 |
| 参考范围比对与异常标记 | P0 | 2天 |
| 工作清单 (Worklist) | P1 | 2天 |
| PDF 报告生成 | P0 | 3天 |
| 异常数据池 (未匹配结果) | P1 | 2天 |

**交付物**：
- 完整的手动检验流程
- 可打印的专业报告
- 异常值高亮显示

---

### Phase 3: 仪器中间件引擎 (4 周) - 核心价值

**目标**：实现"即插即用"的仪器数据自动采集

#### 3.1 通讯层 (1.5 周)

| 任务 | 优先级 | 预估时间 |
|------|--------|----------|
| RS232 串口通讯服务 (serialport) | P0 | 3天 |
| TCP/IP 网络通讯服务 | P1 | 2天 |
| 文件监听服务 (CSV/TXT/XML) | P1 | 2天 |
| 通讯状态监控与断线重连 | P0 | 2天 |

#### 3.2 协议解析层 (1.5 周)

| 任务 | 优先级 | 预估时间 |
|------|--------|----------|
| ASTM E1381/E1394 协议解析器 | P0 | 4天 |
| HL7 v2.x 基础解析器 | P1 | 3天 |
| CSV/通用文本解析器 | P1 | 2天 |

#### 3.3 驱动与映射 (1 周)

| 任务 | 优先级 | 预估时间 |
|------|--------|----------|
| 仪器驱动库架构设计 | P0 | 2天 |
| 第一批驱动 (Sysmex XP-100, Mindray BC-2800/3000) | P0 | 3天 |
| 测试代码映射界面 (仪器代码 -> LIMS项目) | P0 | 2天 |

**交付物**：
- 后台串口监听服务 (托盘常驻)
- ASTM 协议解析引擎
- 至少 2-3 款主流仪器的驱动
- 数据自动入库与匹配

---

### Phase 4: 数据安全与稳定性 (2 周)

**目标**：确保数据安全与系统稳定

| 任务 | 优先级 | 预估时间 |
|------|--------|----------|
| SQLCipher 数据库加密 | P0 | 3天 |
| 用户登录与权限控制 | P0 | 2天 |
| 一键备份与恢复 | P0 | 2天 |
| 审计日志 (关键操作留痕) | P1 | 2天 |
| 断电恢复与数据一致性保障 | P0 | 2天 |
| 低配硬件性能优化 (2-4GB RAM) | P1 | 2天 |

**交付物**：
- 加密的本地数据库
- 角色权限系统
- 备份/恢复功能

---

### Phase 5: 打包与激活 (1.5 周)

**目标**：生成可分发的安装包

| 任务 | 优先级 | 预估时间 |
|------|--------|----------|
| Electron Builder 打包 (Windows/Mac) | P0 | 2天 |
| 硬件指纹生成 (Machine ID) | P0 | 2天 |
| 离线 License Key 验证机制 | P0 | 2天 |
| 安装向导与首次配置引导 | P1 | 2天 |

**交付物**：
- Windows .exe 安装包
- Mac .dmg 安装包
- 离线激活机制

---

### Phase 6: 质量控制模块 (2 周) - 可选增强

**目标**：符合 ISO 15189 基础合规要求

| 任务 | 优先级 | 预估时间 |
|------|--------|----------|
| QC 模块 (L-J 图, Westgard 规则) | P2 | 4天 |
| 质控失败锁定审核功能 | P2 | 2天 |
| 危急值确认弹窗 | P1 | 2天 |
| TAT 周转时间看板 | P2 | 2天 |
| 合规免责声明 (报告页脚) | P0 | 1天 |

---

## 技术关键点

### 仪器通讯要点

1. **RS232 连接**
   - 推荐 FTDI 芯片 USB 转串口适配器
   - 使用 Null Modem 交叉线 (DTE-DTE)
   - 默认参数: 9600 bps / 8N1 / 无流控

2. **ASTM 协议状态机**
   ```
   Idle -> ENQ -> ACK -> STX[Data]ETX[Checksum] -> ACK -> EOT
   ```

3. **数据匹配策略**
   - 优先通过 Sample ID 自动匹配
   - 匹配失败进入"异常数据池"待人工认领
   - 过滤直方图等大体积数据

### 安全要点

1. **数据加密**: SQLCipher (AES-256)
2. **密钥存储**: Electron safeStorage API (系统凭据存储)
3. **密码哈希**: bcrypt (加盐)

### 性能要点

1. **SQLite WAL 模式**: 支持读写并发
2. **主进程常驻**: UI 关闭后仍可采集数据
3. **低内存优化**: 目标 2-4GB RAM 可用

---

## 风险与规避

| 风险 | 影响 | 规避策略 |
|------|------|----------|
| 仪器协议兼容性差 | 高 | 预置驱动库 + 可配置映射表 |
| 老旧硬件性能不足 | 中 | SQLite 轻量化 + 渐进加载 |
| 盗版泛滥 | 中 | 硬件指纹绑定 + 离线激活 |
| 被认定为医疗器械 (SaMD) | 高 | 功能限定为"行政管理"，不提供诊断建议 |

---

## 预估总时间线

| 阶段 | 时间 | 累计 |
|------|------|------|
| Phase 1: 基础架构 | 2 周 | 2 周 |
| Phase 2: MVP 业务流程 | 3 周 | 5 周 |
| Phase 3: 仪器中间件 | 4 周 | 9 周 |
| Phase 4: 安全与稳定 | 2 周 | 11 周 |
| Phase 5: 打包与激活 | 1.5 周 | 12.5 周 |
| Phase 6: QC 模块 (可选) | 2 周 | 14.5 周 |

**MVP 交付预估**: 约 9-11 周 (Phase 1-4)
**完整 V1.0 交付**: 约 12-15 周

---

## 商业模式

- **定价**: $300-$500 永久买断
- **年度维护费 (可选)**: $50-$100/年 (技术支持 + 驱动更新)
- **分发渠道**: 本地医疗设备经销商、IT 集散地 (如 Computer Village)、NGO 合作
