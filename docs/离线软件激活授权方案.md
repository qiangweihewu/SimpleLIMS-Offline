# 离线软件激活授权体系设计方案 (SimpleLIMS V2.1)

> **版本**: 2.1 (增补评审意见)  
> **更新日期**: 2026-02-06  
> **状态**: 待实施

---

## 1. 核心设计理念

针对基础设施较差、可能无网络或只能通过低端手机访问网络的离线医疗环境，本方案的核心目标是在**极致的用户便捷性**与**严格的商业安全性**之间取得平衡。

**核心策略：**
*   **固定短入口**：用户只需访问一个极短的固定网址，无需输入长串字符。
*   **双盲验证**：必须同时持有"当前设备码"和"购买序列号"才能通过验证。
*   **离线强绑定**：激活码与特定硬件指纹绑定，防止一码多用。

---

## 2. 用户操作流程 (User Journey)

### 2.1 标准激活流程

```
┌─────────────────┐             ┌─────────────────┐             ┌─────────────────┐
│  离线电脑 (LIMS) │             │    用户手机      │             │  激活服务器      │
└────────┬────────┘             └────────┬────────┘             └────────┬────────┘
         │                               │                               │
    1️⃣ 显示激活界面                       │                               │
    - 网址: lims.me                       │                               │
    - 设备码: K9P2-X5M8-A3B7             │                               │
    - 二维码 (可选)                        │                               │
         │                               │                               │
         │       2️⃣ 访问 lims.me          │                               │
         │                               │─────────────────────────────▶│
         │                               │                               │
         │       3️⃣ 输入设备码 + 序列号    │                               │
         │                               │─────────────────────────────▶│
         │                               │                               │
         │                               │◀─ 4️⃣ 返回激活码 ──────────────│
         │                               │   (显示二维码+文本+下载文件)    │
         │                               │                               │
    5️⃣ 输入激活码 或 导入.lic文件          │                               │
         │◀──────────────────────────────│                               │
         │                               │                               │
    6️⃣ 验证成功，软件解锁                  │                               │
         │                               │                               │
```

### 2.2 设备更换/重装流程

```
用户电脑损坏 → 联系客服 → 提供购买凭证(SN) → 客服后台解绑 → 用户在新设备重新激活
```

---

## 3. 技术实现架构

### 3.1 编码规范 (Human-Readable)

#### A. 设备码 (Device Code)

| 属性 | 规格 |
|------|------|
| **原始数据** | SHA-256(Platform + Arch + CPUs + TotalMem + MAC) |
| **编码算法** | Base58 (去除 0, O, I, l 等易混字符) |
| **长度** | **12 位** (分 3 组显示) |
| **格式示例** | `K9P2 - X5M8 - A3B7` |
| **熵值** | 58^12 ≈ 2^70，碰撞概率极低 |

#### B. 序列号 (Serial Number - SN)

| 属性 | 规格 |
|------|------|
| **生成方式** | 预生成，存储于销售数据库 |
| **格式** | `LIMS-XXXX-XXXX-XXXX` (16位) |
| **示例** | `LIMS-2026-A7X9-P3M5` |
| **唯一性** | 全局唯一，服务端校验 |

#### C. 最终激活码 (Activation Key)

| 属性 | 规格 |
|------|------|
| **签名算法** | Ed25519 (签名 64 字节) |
| **编码** | Base64 URL Safe |
| **长度** | ~88 字符 (分 11 组显示) |
| **格式示例** | `Wxk9-P2m5-X4y8-...` (共 11 组) |
| **传输方式** | 手动输入 / 二维码 / `.lic` 文件 |

> ⚠️ **重要**: 激活码不可压缩为"12位短码"，因为签名必须完整才能保证安全。我们通过**多种传输方式**来降低用户输入负担。

---

### 3.2 许可证 Payload 结构

```json
{
  "machineId": "K9P2X5M8A3B7",      // 12位设备码
  "sn": "LIMS-2026-A7X9-P3M5",      // 序列号
  "type": "professional",           // trial | professional | enterprise
  "features": 15,                   // 功能位掩码 (bit0: 基础, bit1: 影像, ...)
  "issuedAt": "2026-02-06T00:00:00Z",
  "expiresAt": "2027-02-06T00:00:00Z",
  "maxRebinds": 3                   // 允许重绑次数
}
```

**功能位掩码定义:**

| Bit | 功能模块 |
|-----|----------|
| 0 | 基础检验 |
| 1 | 患者管理 |
| 2 | 仪器对接 |
| 3 | 报告生成 |
| 4 | 影像采集 |
| 5 | 云同步 |
| 6 | 高级报表 |
| 7 | 保留 |

---

### 3.3 安全防护体系

#### A. 防止"一码多用"

1. **服务端绑定记录**：SN 首次激活时，服务器记录 `SN <-> DeviceCode` 映射。
2. **重复请求拒绝**：同一 SN 尝试激活不同设备码时，返回 `ERR_ALREADY_BOUND`。
3. **解绑机制**：
   - 每个 SN 最多允许 3 次重绑（用于设备更换）。
   - 重绑需要客服后台操作，有审计日志。

#### B. 防止"批量扫号/爆破"

1. **双因素验证**：必须同时提供 `设备码` + `序列号`。
2. **CAPTCHA**：表单提交前加入 Cloudflare Turnstile 验证。
3. **速率限制**：
   - 单 IP 5 次失败后封禁 1 小时。
   - 单 SN 3 次失败后锁定 24 小时。
4. **请求日志**：记录所有激活请求，便于异常分析。

#### C. 防止"时间篡改"

1. **时间漂移检测**：
   ```
   if (currentTime < lastVerifiedTime - 1hour) {
     lockApp("系统时间异常，请校正后重试");
   }
   ```
2. **每次启动更新 `lastVerifiedTime`**：
   - 存储在加密的本地配置文件中。
   - 配置文件使用 HMAC 校验防篡改。

#### D. 防止"本地逆向/破解"

1. **代码混淆**：使用 JavaScript Obfuscator 保护前端验证逻辑。
2. **ASAR 加密**：Electron 应用使用 ASAR 整体加密。
3. **完整性校验**：启动时校验主程序 Hash。
4. **关键逻辑加密**：核心算法使用激活码派生密钥解密后才能运行。

---

## 4. 后端接口设计

### 4.1 API 接口

| 接口 | 方法 | 参数 | 功能 |
|------|------|------|------|
| `POST /api/activate` | POST | `sn`, `deviceCode`, `captcha` | 验证并生成激活码 |
| `GET /api/status/:sn` | GET | - | 查询 SN 状态 (客服) |
| `POST /api/unbind` | POST | `sn`, `reason`, `adminToken` | 解绑设备 (客服) |
| `POST /api/sn/generate` | POST | `count`, `type`, `adminToken` | 批量生成 SN |
| `GET /api/sn/export` | GET | `format` | 导出 SN 列表 (CSV/Excel) |

### 4.2 错误码定义

| 错误码 | 说明 |
|--------|------|
| `SUCCESS` | 激活成功 |
| `ERR_INVALID_SN` | 序列号无效 |
| `ERR_ALREADY_BOUND` | 序列号已绑定其他设备 |
| `ERR_MAX_REBINDS` | 已达最大重绑次数 |
| `ERR_RATE_LIMITED` | 请求过于频繁 |
| `ERR_CAPTCHA_FAILED` | 验证码校验失败 |

---

## 5. 客户端实现要点

### 5.1 激活界面 UI

```
┌──────────────────────────────────────────────────┐
│                 🔐 软件激活                       │
├──────────────────────────────────────────────────┤
│                                                  │
│  📱 请用手机访问: lims.me                         │
│                                                  │
│  ┌──────────────────────────────────────────┐   │
│  │           [  二维码图片  ]                │   │
│  └──────────────────────────────────────────┘   │
│                                                  │
│  📟 本机设备码:                                  │
│  ┌──────────────────────────────────────────┐   │
│  │    K9P2  -  X5M8  -  A3B7                │   │
│  └──────────────────────────────────────────┘   │
│                                                  │
│  ─────────────── 输入激活码 ───────────────────  │
│                                                  │
│  ┌──────────────────────────────────────────┐   │
│  │  [                                    ]  │   │
│  └──────────────────────────────────────────┘   │
│                                                  │
│  [ 从文件导入 (.lic) ]        [ 激活 ]          │
│                                                  │
│  ─────────────────────────────────────────────  │
│  试用期剩余: 25 天                               │
└──────────────────────────────────────────────────┘
```

### 5.2 文件导入支持

- 支持 `.lic` 文件导入（JSON 格式，包含签名）。
- 用户可通过 USB 将激活文件从手机/网吧电脑拷贝到离线设备。

### 5.3 时间漂移检测

```typescript
function checkTimeIntegrity(): boolean {
  const lastTime = getStoredLastVerifiedTime();
  const now = Date.now();
  
  // 允许 1 小时向后偏移（时区/夏令时/CMOS问题）
  if (now < lastTime - 3600000) {
    return false; // 时间倒退异常
  }
  
  setStoredLastVerifiedTime(now);
  return true;
}
```

---

## 6. 运维管理

### 6.1 Admin Dashboard 功能

| 功能 | 说明 |
|------|------|
| SN 管理 | 批量生成、导出、查询状态 |
| 激活记录 | 查看所有激活日志、筛选异常 |
| 解绑操作 | 客服解绑设备、记录原因 |
| 统计报表 | 激活率、试用转化、地区分布 |
| 告警通知 | 异常请求模式自动告警 |

### 6.2 监控指标

- 每日激活量
- 激活成功率
- 异常请求占比
- SN 库存预警

---

## 7. 实施路线图

| 阶段 | 任务 | 优先级 | 状态 |
|------|------|--------|------|
| **Phase 1** | 修改 Machine ID 生成逻辑 (12位 Base58) | P0 | ✅ 已完成 |
| **Phase 1** | 更新激活 UI (显示设备码+二维码) | P0 | ✅ 已完成 |
| **Phase 1** | 添加 .lic 文件导入支持 | P0 | ✅ 已完成 |
| **Phase 2** | 实现时间漂移检测 | P1 | ✅ 已完成 |
| **Phase 2** | 添加 features 位掩码支持 | P1 | ✅ 已完成 |
| **Phase 3** | 开发激活服务端 API | P1 | ✅ 已完成 |
| **Phase 3** | 开发 Admin Dashboard | P2 | ✅ 已完成 |

---

## 8. 附录

### 8.1 Base58 字符集

```
123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz
```
(去除: 0, O, I, l)

### 8.2 参考实现

| 文件 | 说明 |
|------|------|
| `electron/services/license-service.ts` | 设备码生成、激活验证、时间检测 |
| `src/pages/ActivationPage.tsx` | 客户端激活页面 UI |
| `src/components/ui/alert.tsx` | Alert 组件 |
| `activation-server/api/activate.ts` | 用户激活 API |
| `activation-server/api/admin/sn.ts` | 管理员 API |
| `activation-server/public/index.html` | 用户激活网页 |
| `activation-server/public/admin.html` | 管理后台 |
| `scripts/generate-license.ts` | 本地生成激活码脚本 |



# 1. 进入目录
cd activation-server

# 2. 安装依赖
npm install

# 3. 链接 Vercel 项目
npx vercel link

# 4. 在 Vercel Dashboard 中:
#    - 创建 KV 存储
#    - 配置环境变量:
#      - PRIVATE_KEY: 私钥内容
#      - ADMIN_PASSWORD: 管理密码

# 5. 部署
npx vercel --prod


完整激活流程总结
┌──────────────────────────────────────────────────────────────────┐
│                        完整激活流程                              │
├──────────────────────────────────────────────────────────────────┤
│                                                                  │
│  1️⃣ 你 (管理员) 在后台生成序列号                                 │
│     访问: https://your-domain.vercel.app/admin.html              │
│     生成: LIMS-2026-A7X9-P3M5                                    │
│                                                                  │
│  2️⃣ 用户购买软件，你提供序列号                                   │
│                                                                  │
│  3️⃣ 用户安装 SimpleLIMS，看到激活页面                           │
│     显示设备码: K9P2-X5M8-A3B7                                   │
│                                                                  │
│  4️⃣ 用户用手机访问激活网站                                       │
│     https://your-domain.vercel.app/?mid=K9P2-X5M8-A3B7          │
│                                                                  │
│  5️⃣ 用户输入序列号，获取激活码                                   │
│     (可复制或下载 .lic 文件)                                     │
│                                                                  │
│  6️⃣ 用户在 SimpleLIMS 中输入激活码或导入文件                     │
│     激活成功！                                                   │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘

⚠️ 部署前注意事项
私钥配置: 将 
scripts/private_key.pem
 的内容配置到 Vercel 环境变量 PRIVATE_KEY
管理密码: 设置强密码作为 ADMIN_PASSWORD
KV 存储: 必须在 Vercel 创建 KV 存储并连接到项目
自定义域名: 建议配置短域名如 lims.me 便于用户输入